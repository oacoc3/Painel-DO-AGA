<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel DO-AGA</title>
  <link rel="stylesheet" href="./assets/styles.css" />
  <!-- jsPDF (exportar PDF da Análise Documental) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js" defer></script>
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- App scripts -->
  <script defer src="./js/supabaseClient.js"></script>
  <script defer src="./js/ui.js"></script>
  <script defer src="./js/auth.js"></script>
  <script defer src="./js/dashboard.js"></script>
  <script defer src="./js/admin.js"></script>
  <script defer src="./js/processos.js"></script>
  <script defer src="./js/prazos.js"></script>
  <script defer src="./js/modelos.js"></script>
  <script defer src="./js/analise_ad.js"></script>
  <script defer src="./js/app.js"></script>
</head>
<body>
  <!-- Layout em Grid: sem rolagem de página, apenas rolagem interna -->
  <div id="app-grid">
    <header id="topbar">
      <div class="brand">
        <span class="logo">DO-AGA</span>
        <span class="appname">Painel</span>
      </div>
      <nav id="main-nav" class="hidden">
        <button data-route="#/dashboard">Início</button>
        <button data-route="#/processos">Processos</button>
        <button data-route="#/prazos">Prazos</button>
        <button data-route="#/modelos">Modelos</button>
        <button data-route="#/analise-documental">Análise Documental</button>
        <button data-route="#/administracao" data-role="ADMIN">Administração</button>
      </nav>

      <div class="userbox hidden" id="userbox">
        <span id="user-ident"></span>
        <span id="user-role" class="tag"></span>
        <button id="btn-logout" title="Sair">Sair</button>
      </div>
    </header>

    <main id="main">
      <!-- Roteamento SPA -->
      <section id="route-login" class="route">
        <div class="card login-card">
          <h1>Entrar</h1>
          <form id="form-login">
            <label>E-mail <input type="email" id="login-email" required></label>
            <label>Senha <input type="password" id="login-password" required></label>
            <button type="submit">Acessar</button>
            <div class="row small">
              <a href="#" id="link-forgot">Esqueci minha senha</a>
            </div>
          </form>

          <!-- troca obrigatória de senha no primeiro login -->
          <div id="force-change" class="hidden">
            <hr/>
            <h2>Trocar senha (obrigatório)</h2>
            <form id="form-force-change">
              <label>Nova senha <input type="password" id="force-pass-1" required minlength="8"></label>
              <label>Confirmar nova senha <input type="password" id="force-pass-2" required minlength="8"></label>
              <button type="submit">Atualizar senha</button>
            </form>
          </div>

          <!-- recuperação de senha -->
          <div id="recover-box" class="hidden">
            <hr/>
            <h2>Recuperar senha</h2>
            <form id="form-recover">
              <label>E-mail <input type="email" id="recover-email" required></label>
              <button type="submit">Enviar e-mail de recuperação</button>
            </form>
            <p class="small">Você receberá um link por e-mail; ao abrir no navegador, a SPA detecta o token e pedirá a nova senha.</p>
          </div>
          <div id="auth-msg" class="msg"></div>
        </div>
      </section>

      <section id="route-dashboard" class="route hidden">
        <div class="panel">
          <div class="panel-header">
            <h1>Indicadores</h1>
            <div class="filters">
              <label>Data 1ª entrada (de)
                <input type="date" id="dash-from">
              </label>
              <label>(até)
                <input type="date" id="dash-to">
              </label>
              <button id="dash-apply">Aplicar</button>
            </div>
          </div>

          <div class="rings" id="rings"></div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>Status</th><th>Qtd</th><th>Velocidade média (dias/processo)</th></tr>
              </thead>
              <tbody id="dash-table"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="route-processos" class="route hidden">
        <div class="split">
          <!-- Coluna esquerda: cadastro/atualização -->
          <div class="col">
            <div class="panel">
              <div class="panel-header"><h2>Cadastro/Atualização</h2></div>
              <div class="panel-body">
                <form id="form-processo">
                  <input type="hidden" id="proc-id">
                  <label>NUP (#####.######/####-##)
                    <input type="text" id="proc-nup" maxlength="20" placeholder="00000.000000/0000-00" required>
                  </label>
                  <label>Tipo
                    <select id="proc-tipo" required>
                      <option value="PDIR">PDIR</option>
                      <option value="INSCRICAO">Inscrição</option>
                      <option value="ALTERACAO">Alteração</option>
                      <option value="EXPLORACAO">Exploração</option>
                      <option value="OPEA">OPEA</option>
                    </select>
                  </label>
                  <div class="row">
                    <label>Obra concluída?
                      <select id="proc-obra-concluida">
                        <option value="false">Não</option>
                        <option value="true">Sim</option>
                      </select>
                    </label>
                    <label>Data término de obra
                      <input type="date" id="proc-obra-termino">
                    </label>
                  </div>
                  <label>Data de 1ª entrada na DO-AGA
                    <input type="date" id="proc-entrada" required>
                  </label>
                  <label>Status do processo
                    <select id="proc-status" required></select>
                  </label>
                  <div class="row">
                    <button type="submit" id="btn-proc-salvar" disabled>Salvar</button>
                    <button type="button" id="btn-proc-novo">Novo</button>
                  </div>
                </form>
                <div class="msg" id="proc-msg"></div>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header"><h3>Pareceres internos</h3></div>
              <div class="panel-body">
                <form id="form-parecer">
                  <label>Tipo
                    <select id="par-tipo">
                      <option value="ATM">ATM</option>
                      <option value="DT">DT</option>
                      <option value="CGNA">CGNA</option>
                    </select>
                  </label>
                  <label>Solicitado em
                    <input type="datetime-local" id="par-solicitado">
                  </label>
                  <div class="row">
                    <button type="button" id="btn-par-solicitar">Cadastrar</button>
                    <button type="button" id="btn-par-receber">Marcar RECEBIDO</button>
                  </div>
                  <div class="small">Só é permitido cadastrar se o processo estiver em **ANATEC-PRE** ou **ANATEC** e não existir outro do mesmo tipo com status **SOLICITADO**.</div>
                </form>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header"><h3>Notificações</h3></div>
              <div class="panel-body">
                <form id="form-notif">
                  <label>Tipo
                    <select id="not-tipo">
                      <option value="FAV">FAV</option>
                      <option value="FAV-TERM">FAV-TERM</option>
                      <option value="TERM-ATRA">TERM-ATRA</option>
                      <option value="DESF-NAO_INI">DESF-NAO_INI</option>
                      <option value="DESF_JJAER">DESF_JJAER</option>
                      <option value="DESF-REM_REB">DESF-REM_REB</option>
                      <option value="NCD">NCD</option>
                      <option value="NCT">NCT</option>
                    </select>
                  </label>
                  <label>Solicitada em
                    <input type="datetime-local" id="not-solicitada">
                  </label>
                  <div class="row">
                    <button type="button" id="btn-not-solicitar">Cadastrar</button>
                    <button type="button" id="btn-not-ler">Marcar LIDA</button>
                  </div>
                  <div class="small">Cadastro permitido em **ANADOC, ANATEC-PRE, ANATEC, ANAICA**; tipo não pode ter outra **SOLICITADA**.  
                  Ao ler **NCD** ⇒ status do processo vai para **SOB-DOC**; ao ler **NCT** ⇒ **SOB-TEC**.</div>
                </form>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header"><h3>SIGADAER</h3></div>
              <div class="panel-body">
                <form id="form-sig">
                  <label>Tipo
                    <select id="sig-tipo">
                      <option>COMAE</option><option>COMPREP</option><option>COMGAP</option>
                      <option>GABAER</option><option>SAC</option><option>ANAC</option>
                      <option>OPR_AD</option><option>PREF</option><option>GOV</option><option>OUTRO</option>
                    </select>
                  </label>
                  <label>Solicitado em
                    <input type="datetime-local" id="sig-solicitado">
                  </label>
                  <label>Números (6 dígitos, separados por vírgula)
                    <input type="text" id="sig-numeros" placeholder="123456, 654321">
                  </label>
                  <label>Observação
                    <textarea id="sig-obs" rows="2"></textarea>
                  </label>
                  <div class="row">
                    <button type="button" id="btn-sig-solicitar">Cadastrar</button>
                    <button type="button" id="btn-sig-expedir">Marcar EXPEDIDO</button>
                    <button type="button" id="btn-sig-receber">Marcar RECEBIDO</button>
                  </div>
                  <div class="small">Pode cadastrar em qualquer status. **RECEBIDO** só após **EXPEDIDO**.</div>
                </form>
              </div>
            </div>
          </div>

          <!-- Coluna direita: lista + histórico -->
          <div class="col">
            <div class="panel">
              <div class="panel-header"><h2>Processos cadastrados</h2></div>
              <div class="panel-body">
                <div class="table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th>NUP</th><th>Tipo</th><th>Status</th>
                        <th>1ª Entrada</th><th>Tempo decorrido</th>
                        <th>Par. Solic.?</th><th>Not. Solic.?</th><th>SIG. Exped.?</th>
                      </tr>
                    </thead>
                    <tbody id="proc-list"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header"><h2>Histórico</h2></div>
              <div class="panel-body">
                <div class="table-wrap">
                  <table>
                    <thead>
                      <tr><th>Data/Hora</th><th>Usuário</th><th>Ação</th></tr>
                    </thead>
                    <tbody id="hist-list"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="route-prazos" class="route hidden">
        <div class="grid-3">
          <div class="panel">
            <div class="panel-header"><h2>Pareceres ATM</h2></div>
            <div class="table-wrap"><table>
              <thead><tr><th>NUP</th><th>Prazo</th><th>Restam (dias)</th></tr></thead>
              <tbody id="pl-atm"></tbody>
            </table></div>
          </div>
          <div class="panel">
            <div class="panel-header"><h2>Pareceres DT</h2></div>
            <div class="table-wrap"><table>
              <thead><tr><th>NUP</th><th>Prazo</th><th>Restam (dias)</th></tr></thead>
              <tbody id="pl-dt"></tbody>
            </table></div>
          </div>
          <div class="panel">
            <div class="panel-header"><h2>Pareceres CGNA</h2></div>
            <div class="table-wrap"><table>
              <thead><tr><th>NUP</th><th>Prazo</th><th>Restam (dias)</th></tr></thead>
              <tbody id="pl-cgna"></tbody>
            </table></div>
          </div>
        </div>

        <div class="grid-3">
          <div class="panel">
            <div class="panel-header"><h2>Pareceres Externos</h2></div>
            <div class="table-wrap"><table>
              <thead><tr><th>NUP</th><th>Prazo</th><th>Restam (dias)</th></tr></thead>
              <tbody id="pl-externos"></tbody>
            </table></div>
          </div>
          <div class="panel">
            <div class="panel-header"><h2>Término de Obra</h2></div>
            <div class="table-wrap"><table>
              <thead><tr><th>NUP</th><th>Prazo</th><th>Restam</th><th>Obs</th></tr></thead>
              <tbody id="pl-obra"></tbody>
            </table></div>
          </div>
          <div class="panel">
            <div class="panel-header"><h2>Monitorar Tramitação</h2></div>
            <div class="table-wrap"><table>
              <thead><tr><th>NUP</th><th>Tipo</th><th>Status</th></tr></thead>
              <tbody id="pl-monitor"></tbody>
            </table></div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header"><h2>Prazo DO-AGA</h2></div>
          <div class="table-wrap"><table>
            <thead><tr><th>NUP</th><th>Status Atual</th><th>Prazo (ou Status SOB-*)</th><th>Restam (dias)</th></tr></thead>
            <tbody id="pl-doaga"></tbody>
          </table></div>
        </div>
      </section>

      <section id="route-modelos" class="route hidden">
        <div class="split">
          <div class="col">
            <div class="panel">
              <div class="panel-header"><h2>Novo/Editar modelo</h2></div>
              <div class="panel-body">
                <form id="form-modelo">
                  <input type="hidden" id="modelo-id">
                  <label>Categoria <input type="text" id="modelo-cat" required></label>
                  <label>Título <input type="text" id="modelo-title" required></label>
                  <label>Conteúdo
                    <textarea id="modelo-content" rows="8" required></textarea>
                  </label>
                  <div class="row">
                    <button type="submit" id="btn-modelo-salvar">Salvar</button>
                    <button type="button" id="btn-modelo-novo">Novo</button>
                  </div>
                  <div class="msg" id="modelo-msg"></div>
                </form>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="panel">
              <div class="panel-header"><h2>Modelos cadastrados</h2></div>
              <div class="panel-body">
                <div class="table-wrap"><table>
                  <thead><tr><th>Categoria</th><th>Título</th><th>Ações</th></tr></thead>
                  <tbody id="modelo-list"></tbody>
                </table></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="route-analise" class="route hidden">
        <div class="panel">
          <div class="panel-header"><h1>Análise Documental</h1></div>
          <div class="panel-body">
            <form id="form-analise-setup" class="row">
              <label>NUP
                <input type="text" id="ad-nup" placeholder="00000.000000/0000-00" required>
              </label>
              <label>Tipo
                <select id="ad-tipo">
                  <option value="PDIR">PDIR</option>
                  <option value="INSCRICAO">Inscrição</option>
                  <option value="ALTERACAO">Alteração</option>
                  <option value="EXPLORACAO">Exploração</option>
                  <option value="OPEA">OPEA</option>
                </select>
              </label>
              <button type="button" id="ad-carregar">Carregar checklist aprovada</button>
            </form>

            <div id="ad-checklist" class="checklist hidden"></div>

            <div id="ad-actions" class="row hidden">
              <button id="ad-finalizar">Finalizar e gerar PDF</button>
              <button id="ad-cancelar" class="secondary">Cancelar</button>
            </div>

            <div class="msg" id="ad-msg"></div>
          </div>
        </div>
      </section>
    </main>

    <footer id="footer">
      <div>Build: <span id="build-info">carregando…</span></div>
      <div class="muted">© DO-AGA</div>
    </footer>
  </div>
</body>
</html>
